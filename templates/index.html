{% extends "base.html" %}

{% block content %}

        <!-- Body Start -->
         {% for cle in types %}
            <div class="card__container swiper">
               <div class="type_bar p-3">
                  <div class="type_non text-primary">{{ cle }}</div> <div class="bar_espace"></div>
               </div>
               <div class="card__content">
                  <div class="swiper-wrapper">
               {%  for repas in types[cle] %}     
                        <article class="card__article swiper-slide">
                           <div class="card__image">
                              <img src="{{url_convert(repas.image_url)}}" alt="{{url_convert(repas.image_url)}}" class="card__img" >
                              <div class="card__shadow"></div>
                           </div>
            
                           <div class="card__data">
                              <h3 class="card__name">{{ repas['nom'] }}</h3>
                              <p class="card__description">
                                 {{ cle }} du Cameroun et d'Afrique
                                 {% if session['nom_user'] %}
                                 <form id="formulaire-fav">
                                    <!-- Ajout des identifiants pour pouvoir les sélectionner -->
                                    <input type="hidden" name="repas" id="repas" value="{{ repas['id'] }}">
                                    <input type="hidden" name="user" id="user" value="{{ session['id_user'] }}">
                                    
                                    <!-- Spécifiez le type de bouton pour éviter le comportement submit -->
                                    <button class="btn-favoris" type="submit">
                                        <i class="fa fa-star text-white favoris"></i>
                                    </button>
                                </form>
                                
                                <div id="reponse"></div>
                                
                                <script>
                                    // Vérifiez que le DOM est entièrement chargé avant de lancer le script
                                    document.addEventListener('DOMContentLoaded', function() {
                                        // Sélectionner le formulaire
                                        const formulaire = document.getElementById('formulaire-fav');
                                        
                                        formulaire.addEventListener('submit', async function(event) {
                                            alert('ok');  // Vérification que l'événement est bien capturé
                                            event.preventDefault();  // Empêche la soumission par défaut du formulaire
                                
                                            // Récupération des données du formulaire
                                            const formData = {
                                                repas: document.getElementById('repas').value,  // Sélection correcte de l'input
                                                user: document.getElementById('user').value     // Sélection correcte de l'input
                                            };
                                
                                            try {
                                                // Envoi des données de manière asynchrone via Fetch API
                                                const response = await fetch('/submit-form', {
                                                    method: 'POST',
                                                    headers: {
                                                        'Content-Type': 'application/json'
                                                    },
                                                    body: JSON.stringify(formData)
                                                });
                                
                                                const result = await response.json();
                                                console.log(result);
                                                
                                                // Affichage du message de succès
                                                document.getElementById('reponse').innerText = result.message;
                                
                                            } catch (error) {
                                                console.error('Erreur lors de l\'envoi des données :', error);
                                                document.getElementById('reponse').innerText = 'Erreur lors de l\'envoi du formulaire.';
                                            }
                                        });
                                    });
                                </script>
                                
                                 {% endif %}
                              </p>
                              <form method="post" action="{{ url_for('repas') }}">
                                 <button class="card__button" value="{{repas['id']}}" name = "id">Voir Plus</button>
                              </form>
                           </div>
                        </article>
               {% endfor %}   
         
                  </div>
               </div>
   
               <!-- Navigation buttons -->
               <div class="swiper-button-next text-primary">
                  <i class="ri-arrow-right-s-line"></i>
               </div>
               
               <div class="swiper-button-prev text-primary">
                  <i class="ri-arrow-left-s-line"></i>
               </div>
   
               <!-- Pagination -->
               <div class="swiper-pagination bg-primary text-primary"></div>
            </div>
         {% endfor %}
          
         
         <!--=============== SWIPER JS ===============-->
    <script src="{{ url_for('static', filename='assets/js/swiper-bundle.min.js')}}"></script>
    <script src=""></script>
   
         <!--=============== MAIN JS ===============-->
    <script src="{{ url_for('static', filename='assets/js/main.js')}}"></script>

        <!-- Body End -->
{% endblock %}